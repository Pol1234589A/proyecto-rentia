

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES AUXILIARES (HELPERS) ---

    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Obtiene los datos del usuario actual desde la colección 'users'
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verifica el rol específico
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    // Roles Jerárquicos
    function isStaff() {
      return hasRole('staff') || hasRole('admin') || hasRole('manager');
    }

    function isAgency() {
      return hasRole('agency');
    }

    // Staff extendido (incluye agencias colaboradoras para ciertas lecturas)
    function isInternal() {
      return isStaff() || isAgency();
    }

    function isOwner() {
      return hasRole('owner');
    }

    function isWorker() {
      return hasRole('worker');
    }

    function isTenant() {
      return hasRole('tenant');
    }

    // Helper para operaciones de gestión diaria (Staff + Trabajadores)
    function isStaffOrWorker() {
      return isStaff() || isWorker();
    }

    // --- REGLAS POR COLECCIÓN ---

    // 0. CONFIGURACIÓN WEB (Lectura pública, Edición Staff)
    match /app_config/{configId} {
      allow read: if true;
      allow write: if isStaff();
    }

    // 0.1 BLOG POSTS (Lectura pública, Edición Staff)
    match /blog_posts/{postId} {
      allow read: if true;
      allow write: if isStaff();
    }

    // 1. USUARIOS
    // - Staff: Control total.
    // - Usuario: Solo lee/edita su propio perfil.
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isInternal() || isWorker());
      allow create: if isAuthenticated(); // Permitir creación inicial al registrarse (UserCreator usa admin SDK normalmente, pero esto cubre registros directos si los hubiera)
      allow update: if isStaff() || (isAuthenticated() && request.auth.uid == userId);
      allow delete: if isStaff();
    }

    // 2. PROPIEDADES (Catálogo y Configuración)
    match /properties/{propertyId} {
      // Lectura pública necesaria para el catálogo web. 
      // IMPORTANTE: Evitar guardar información extremadamente sensible en el documento raíz 
      // si no se quiere que sea pública (ej: InternalNotes debería estar protegida).
      allow read: if true;
      
      // Staff y Workers gestionan.
      // Propietarios solo editan SU propiedad.
      allow update: if isStaffOrWorker() || (isOwner() && resource.data.ownerId == request.auth.uid);
      
      // Creación permitida a staff o usuarios autenticados (flujos de alta)
      allow create: if isStaffOrWorker() || isAuthenticated();
      
      allow delete: if isStaff();
    }

    // 3. DOCUMENTOS DE PROPIEDAD
    match /property_documents/{docId} {
      // Staff y Workers ven todo. Owners ven lo suyo.
      allow read: if isStaffOrWorker() || (isOwner() && get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid);
      
      // Creación permitida a autenticados (Owners subiendo docs)
      allow create: if isAuthenticated();
      
      allow update, delete: if isStaff();
    }

    // 4. FACTURAS DE SUMINISTROS (Subidas por Owners o Staff)
    match /supply_invoices/{invoiceId} {
      allow read: if isStaffOrWorker() || (isOwner() && get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid);
      allow create: if isAuthenticated(); 
      allow update, delete: if isStaff();
    }
    
    // 5. CÁLCULOS DE SUMINISTROS (Generados por el sistema/staff)
    match /supply_records/{recordId} {
      allow read: if isStaffOrWorker() || (isOwner() && get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid);
      allow write: if isStaff();
    }

    // 6. AJUSTES ECONÓMICOS (Descuentos/Cargos a propietarios)
    match /adjustments/{adjustmentId} {
      allow read: if isStaff() || (isOwner() && resource.data.ownerId == request.auth.uid);
      allow write: if isStaff();
    }

    // 7. CONTABILIDAD GENERAL
    match /accounting/{docId} {
      allow read, write: if isInternal();
    }

    // 8. OPORTUNIDADES (Inversión)
    match /opportunities/{opportunityId} {
      allow read: if true; // Web pública (Landing)
      allow write: if isInternal(); // Solo Staff/Agency gestiona el portfolio
    }
    
    // 9. CONTRATOS
    match /contracts/{contractId} {
      allow read: if isStaffOrWorker() || 
                  (isOwner() && resource.data.ownerId == request.auth.uid) || 
                  (isTenant() && resource.data.tenantId == request.auth.uid);
      allow write: if isInternal();
    }

    // 10. TAREAS (Gestión interna)
    match /tasks/{taskId} {
      allow read, write: if isStaffOrWorker();
    }

    match /task_boards/{boardId} {
      allow read, write: if isStaffOrWorker();
    }

    // 11. PIPELINE CANDIDATOS (CRM Alquiler)
    match /candidate_pipeline/{candidateId} {
      allow read, update: if isStaffOrWorker();
      allow create: if isAuthenticated(); 
      allow delete: if isInternal();
    }

    // 12. VISITAS (Log de actividad)
    match /room_visits/{visitId} {
      allow read, write: if isStaffOrWorker();
    }

    // 13. NOTICIAS INTERNAS (Tablón)
    match /internal_news/{newsId} {
      allow read: if isAuthenticated(); 
      allow write: if isInternal();
    }

    // 14. FACTURAS TRABAJADORES (Pagos a staff externo)
    match /worker_invoices/{invoiceId} {
      allow read: if isInternal() || (isWorker() && resource.data.workerId == request.auth.uid);
      allow create: if isInternal() || (isWorker() && request.resource.data.workerId == request.auth.uid);
      allow update: if isInternal(); 
      allow delete: if isInternal() || (isWorker() && resource.data.workerId == request.auth.uid && resource.data.status == 'pending');
    }

    // --- FORMULARIOS PÚBLICOS (WEB) ---

    // 15. SOLICITUDES DE COMPRA (Brokers/Particulares)
    match /buyer_requests/{requestId} {
      allow read: if true; 
      allow create: if true; 
      allow update, delete: if isInternal();
    }

    // 16. SOLICITUDES DE VENTA (Colaboradores)
    match /opportunity_requests/{requestId} {
      allow create: if true; 
      allow read, update, delete: if isInternal();
    }
    
    // 17. TRASPASOS DE CARTERA
    match /pending_transfers/{transferId} {
      allow create: if true;
      allow read, update, delete: if isInternal();
    }

    // 18. LEADS DE OPORTUNIDADES (Interesados en invertir)
    match /opportunity_leads/{leadId} {
        allow create: if true; 
        allow read, update, delete: if isInternal();
    }

    // 19. LEADS DE GESTIÓN (Propietarios que quieren gestión)
    match /management_leads/{leadId} {
        allow create: if true; 
        allow read: if isInternal() || isWorker() || (isOwner() && resource.data.linkedOwnerId == request.auth.uid);
        allow update, delete: if isInternal();
    }

    // --- SEGURIDAD Y LOGS ---

    // 20. SALES TRACKER (CRM Ventas)
    match /sales_tracker/{trackId} {
      allow read, write: if isInternal();
    }

    // 21. BLACKLIST (Lista negra inquilinos)
    match /tenant_blacklist/{entryId} {
      allow read, write: if isInternal();
    }

    // 22. FACTURAS DE AGENCIA (Liquidaciones a Owners)
    match /agency_invoices/{invoiceId} {
        allow read: if isInternal() || isWorker() || (isOwner() && resource.data.ownerId == request.auth.uid);
        allow write: if isInternal();
    }

    // Regla por defecto: Bloquear todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}