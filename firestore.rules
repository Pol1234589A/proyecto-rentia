

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES AUXILIARES (HELPERS) ---

    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Obtiene los datos del usuario de forma segura evitando calls innecesarias
    // Usamos get() directamente ya que si el documento no existe devolverá un error 
    // que capturamos con la lógica de roles, pero en v2 es preferible ser explícitos.
    function getUserData() {
      return isAuthenticated() ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data : {};
    }

    // Verifica si el usuario tiene un rol específico
    // Optimizamos para no llamar a getUserData() múltiples veces si no es necesario
    function hasRole(role) {
      let data = getUserData();
      return isAuthenticated() && ('role' in data) && data.role == role;
    }

    // Funciones de conveniencia para roles
    function isStaff() {
      let data = getUserData();
      return isAuthenticated() && ('role' in data) && (data.role == 'staff' || data.role == 'admin' || data.role == 'manager');
    }

    function isWorker() {
      return hasRole('worker');
    }

    function isOwner() {
      return hasRole('owner');
    }
    
    function isTenant() {
      return hasRole('tenant');
    }

    function isAgency() {
      return hasRole('agency');
    }

    function isInternal() {
      return isStaff() || isAgency();
    }

    function isStaffOrWorker() {
      return isStaff() || isWorker();
    }

    // --- REGLAS POR COLECCIÓN ---

    // 0. CONFIGURACIÓN WEB (Lectura pública, Edición Staff)
    match /app_config/{configId} {
      allow read: if true;
      allow write: if isStaff();
    }

    // 0.1 BLOG POSTS (Lectura pública, Edición Staff)
    match /blog_posts/{postId} {
      allow read: if true;
      allow write: if isStaff();
    }

    // 1. USUARIOS
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isStaffOrWorker() || isInternal());
      allow create: if isAuthenticated() && request.auth.uid == userId; 
      allow update: if (isAuthenticated() && request.auth.uid == userId) || isStaff();
      allow delete: if isStaff();
    }

    // 2. PROPIEDADES
    match /properties/{propertyId} {
      allow read: if true;
      allow create: if isAuthenticated(); // Permitir a cualquier logueado (flujo owner o staff)
      allow update: if isStaffOrWorker() || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow delete: if isStaff();
    }

    // 3. DOCUMENTOS DE PROPIEDAD
    match /property_documents/{docId} {
      allow read: if isStaffOrWorker() || (isAuthenticated() && get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update, delete: if isStaff();
    }

    // 4. FACTURAS DE SUMINISTROS
    match /supply_invoices/{invoiceId} {
      allow read: if isStaffOrWorker() || (isAuthenticated() && get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid);
      allow create: if isAuthenticated(); 
      allow update, delete: if isStaff();
    }
    
    // 5. CÁLCULOS DE SUMINISTROS
    match /supply_records/{recordId} {
      allow read: if isStaffOrWorker() || (isAuthenticated() && get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid);
      allow write: if isStaff();
    }

    // 6. AJUSTES ECONÓMICOS
    match /adjustments/{adjustmentId} {
      allow read: if isStaff() || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow write: if isStaff();
    }

    // 7. CONTABILIDAD
    match /accounting/{docId} {
      allow read, write: if isStaff();
    }

    // 8. OPORTUNIDADES
    match /opportunities/{opportunityId} {
      allow read: if true;
      allow write: if isInternal();
    }
    
    // 9. CONTRATOS
    match /contracts/{contractId} {
      allow read: if isStaffOrWorker() || 
                  (isAuthenticated() && (resource.data.ownerId == request.auth.uid || resource.data.tenantId == request.auth.uid));
      allow write: if isStaffOrWorker();
    }

    // 10. TAREAS
    match /tasks/{taskId} {
      allow read, write: if isStaffOrWorker();
    }
    match /task_boards/{boardId} {
      allow read, write: if isStaffOrWorker();
    }

    // 11. PIPELINE CANDIDATOS
    match /candidate_pipeline/{candidateId} {
      allow read, update: if isStaffOrWorker();
      allow create: if true;
      allow delete: if isInternal();
    }

    // 12. VISITAS
    match /room_visits/{visitId} {
      allow read, write: if isStaffOrWorker();
    }

    // 13. NOTICIAS INTERNAS
    match /internal_news/{newsId} {
      allow read: if isAuthenticated(); 
      allow write: if isInternal();
    }

    // 14. FACTURAS TRABAJADORES
    match /worker_invoices/{invoiceId} {
      allow read: if isInternal() || (isAuthenticated() && resource.data.workerId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.workerId == request.auth.uid;
      allow update: if isInternal(); 
      allow delete: if isInternal() || (isAuthenticated() && resource.data.workerId == request.auth.uid && resource.data.status == 'pending');
    }

    // 15. SOLICITUDES DE COMPRA
    match /buyer_requests/{requestId} {
      allow read: if true; 
      allow create: if true; 
      allow update, delete: if isInternal();
    }

    // 16. SOLICITUDES DE VENTA
    match /opportunity_requests/{requestId} {
      allow create: if true; 
      allow read, update, delete: if isInternal();
    }
    
    // 17. TRASPASOS DE CARTERA
    match /pending_transfers/{transferId} {
      allow create: if true;
      allow read, update, delete: if isInternal();
    }

    // 18. LEADS DE OPORTUNIDADES
    match /opportunity_leads/{leadId} {
        allow create: if true; 
        allow read, update, delete: if isInternal();
    }

    // 19. LEADS DE GESTIÓN
    match /management_leads/{leadId} {
        allow create: if true; 
        allow read: if (isAuthenticated() && resource.data.linkedOwnerId == request.auth.uid) || isStaffOrWorker() || isInternal();
        allow update, delete: if isInternal();
    }

    // 20. LEADS DE ALQUILER
    match /tenant_leads/{leadId} {
        allow create: if true;
        allow read: if isStaffOrWorker();
        allow update, delete: if isInternal();
    }

    // 21. SALES TRACKER
    match /sales_tracker/{trackId} {
      allow read, write: if isInternal();
    }

    // 22. BLACKLIST
    match /tenant_blacklist/{entryId} {
      allow read, write: if isInternal();
    }

    // 23. FACTURAS DE AGENCIA
    match /agency_invoices/{invoiceId} {
        allow read: if (isAuthenticated() && resource.data.ownerId == request.auth.uid) || isStaffOrWorker() || isInternal();
        allow write: if isInternal();
    }

    // Default: Bloquear accesos no definidos
    match /{document=**} {
      allow read, write: if false;
    }
  }
}